# 테스트 가이드

**프로젝트명:** SimpleBlog
**작성일:** 2025-10-17
**작성자:** 개발팀
**버전:** 1.0

---

## 📌 이 단계의 목적

### 왜 테스트를 작성하나요?

**"만든 기능이 제대로 동작하는지 확인하자!"**

테스트는 **품질 보증**의 핵심입니다. PM은 "테스트 커버리지 80%"같은 용어를 알아야 고객에게 설명할 수 있습니다.

#### 예시로 이해하기
```
테스트 없이 개발:
개발자: "다 만들었습니다!"
배포 → 고객이 사용 → 버그 발견 → 긴급 수정 → 야근

테스트 작성 후 개발:
개발자: "테스트 200개 통과했습니다!"
배포 → 고객이 사용 → 문제 없음 → 정시 퇴근
```

### PM이 꼭 알아야 할 것

#### 1. 테스트 종류 (3가지만 기억!)

```
1. 단위 테스트 (Unit Test):
   - 메서드 하나씩 테스트
   - 가장 빠름 (1초 내)
   - 개발자가 가장 많이 작성

2. 통합 테스트 (Integration Test):
   - 여러 계층 함께 테스트
   - 중간 속도 (5~10초)
   - 실제 DB 사용

3. E2E 테스트 (End-to-End):
   - 사용자 시나리오 전체 테스트
   - 느림 (30초~1분)
   - Selenium, Cypress 등 사용
```

---

#### 2. 테스트 커버리지

```
테스트 커버리지 = 테스트된 코드 라인 수 / 전체 코드 라인 수

일반적인 목표:
- 70% 이상: 준수
- 80% 이상: 우수
- 90% 이상: 매우 우수 (하지만 과도할 수 있음)

SimpleBlog 목표: 80%
```

**제안서에 쓰는 표현:**
> "SimpleBlog는 **테스트 커버리지 80%** 이상을 보장합니다.
> JUnit 5 기반 **자동화 테스트 200개** 이상 작성하여,
> **회귀 버그를 사전에 방지**합니다."

---

#### 3. 실무 Tip

⭐ **테스트는 개발과 동시에**
```
❌ 나쁜 예: 개발 다 하고 나중에 테스트 작성
→ 귀찮아서 안 쓰게 됨

✅ 좋은 예: 기능 하나 만들 때마다 테스트 작성
→ TDD (Test Driven Development)
```

⭐ **given-when-then 패턴**
```java
@Test
void 게시글_생성_성공() {
    // given: 준비 (테스트 데이터 설정)
    PostCreateRequest request = new PostCreateRequest(...);

    // when: 실행 (테스트할 기능 실행)
    PostResponse response = postService.createPost(request);

    // then: 검증 (결과 확인)
    assertThat(response.getTitle()).isEqualTo("테스트 제목");
}
```

⭐ **테스트 실패는 정상!**
```
테스트가 실패한다 = 버그를 찾았다!
→ 고객에게 배포 전에 발견한 것이 다행

테스트가 항상 성공한다 = 테스트를 잘못 작성했거나, 버그가 없거나
```

---

#### 4. 제안서/PT에서 설명하는 법

**테스트 전략 설명 예시:**

> "SimpleBlog는 **3단계 테스트 전략**을 적용합니다.
>
> **1단계: 단위 테스트 (Unit Test)**
> - JUnit 5 + Mockito
> - Service, Repository 계층 테스트
> - CI/CD 파이프라인에서 자동 실행
>
> **2단계: 통합 테스트 (Integration Test)**
> - MockMvc + Testcontainers
> - Controller → Service → Repository 전체 흐름 테스트
> - 실제 MySQL 컨테이너 사용
>
> **3단계: 인수 테스트 (Acceptance Test)**
> - Postman Collection
> - 실제 시나리오 기반 테스트
> - 고객과 함께 진행
>
> **품질 지표:**
> - 테스트 커버리지: 80% 이상
> - 테스트 실행 시간: 5분 이내
> - CI/CD 빌드 성공률: 95% 이상"

---

#### 5. 공무원이 자주 하는 질문

**Q1: "테스트는 왜 하나요? 개발자가 확인하면 안 되나요?"**
A: "사람은 실수합니다.

   개발자 A가 게시글 생성 기능을 만들었습니다.
   → 나중에 개발자 B가 다른 기능을 수정했는데,
   → 게시글 생성 기능이 망가졌습니다!

   **자동화 테스트가 있으면:**
   → 코드 변경 시마다 200개 테스트 자동 실행
   → 망가진 기능 즉시 발견
   → 배포 전에 수정"

**Q2: "테스트 작성하면 개발 기간이 늘어나지 않나요?"**
A: "초기에는 20% 더 걸립니다.
   하지만 장기적으로는 시간을 절약합니다.

   **테스트 없는 프로젝트:**
   - 개발: 10일
   - 버그 수정: 5일
   - 재배포: 2일
   **총: 17일**

   **테스트 있는 프로젝트:**
   - 개발 + 테스트: 12일
   - 버그 수정: 1일
   **총: 13일**

   → 테스트가 있으면 **30% 빠름!**"

**Q3: "테스트 커버리지 100%는 안 되나요?"**
A: "100%는 비현실적이고 비효율적입니다.

   테스트할 필요 없는 코드:
   - Getter/Setter (Lombok이 자동 생성)
   - 단순 상수 정의
   - 설정 파일

   80% 정도가 **비용 대비 효과**가 가장 좋습니다.
   100%를 위해 20%를 더 투자하는 것은 낭비입니다."

**Q4: "테스트 실패하면 배포 못 하나요?"**
A: "네, 맞습니다.

   CI/CD 파이프라인 설정:
   ```
   코드 커밋 → 테스트 자동 실행 → 통과 시에만 배포
   ```

   **장점:**
   - 망가진 코드가 운영 환경에 절대 배포 안 됨
   - 품질 보장

   **단점:**
   - 긴급 배포 시 시간 걸림
   → 핫픽스(HotFix) 절차로 해결"

---

## 1. 테스트 환경 설정

### 1.1 build.gradle 의존성

```groovy
dependencies {
    // 기존 dependencies...

    // Test
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    // Testcontainers (실제 MySQL 컨테이너로 테스트)
    testImplementation 'org.testcontainers:testcontainers:1.19.0'
    testImplementation 'org.testcontainers:mysql:1.19.0'
    testImplementation 'org.testcontainers:junit-jupiter:1.19.0'
}
```

### 1.2 테스트 설정 파일

**src/test/resources/application.yml:**
```yaml
spring:
  datasource:
    # Testcontainers가 자동으로 설정
    url: jdbc:tc:mysql:8.0:///testdb
    driver-class-name: org.testcontainers.jdbc.ContainerDatabaseDriver

  jpa:
    hibernate:
      ddl-auto: create-drop  # 테스트 시작 시 생성, 종료 시 삭제
    show-sql: true

logging:
  level:
    com.simpleblog: DEBUG
    org.testcontainers: INFO
```

---

## 2. 단위 테스트 (Unit Test)

### 2.1 Repository 테스트

**PostRepositoryTest.java:**
```java
package com.simpleblog.repository;

import com.simpleblog.entity.Post;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;

import java.util.List;
import java.util.Optional;

import static org.assertj.core.api.Assertions.*;

@DataJpaTest  // JPA 관련 Bean만 로드 (빠른 테스트)
class PostRepositoryTest {

    @Autowired
    private PostRepository postRepository;

    @Test
    @DisplayName("게시글 저장 성공")
    void save_success() {
        // given
        Post post = Post.builder()
                .title("테스트 제목")
                .content("테스트 내용")
                .author("테스터")
                .build();

        // when
        Post savedPost = postRepository.save(post);

        // then
        assertThat(savedPost.getId()).isNotNull();
        assertThat(savedPost.getTitle()).isEqualTo("테스트 제목");
    }

    @Test
    @DisplayName("게시글 ID로 조회 성공")
    void findById_success() {
        // given
        Post post = Post.builder()
                .title("테스트 제목")
                .content("테스트 내용")
                .author("테스터")
                .build();
        Post savedPost = postRepository.save(post);

        // when
        Optional<Post> foundPost = postRepository.findById(savedPost.getId());

        // then
        assertThat(foundPost).isPresent();
        assertThat(foundPost.get().getTitle()).isEqualTo("테스트 제목");
    }

    @Test
    @DisplayName("게시글 최신순 조회 성공")
    void findAllByOrderByCreatedAtDesc_success() {
        // given
        postRepository.save(Post.builder()
                .title("첫 번째")
                .content("내용")
                .author("테스터")
                .build());

        postRepository.save(Post.builder()
                .title("두 번째")
                .content("내용")
                .author("테스터")
                .build());

        // when
        List<Post> posts = postRepository.findAllByOrderByCreatedAtDesc();

        // then
        assertThat(posts).hasSize(2);
        assertThat(posts.get(0).getTitle()).isEqualTo("두 번째");  // 최신순
    }

    @Test
    @DisplayName("게시글 삭제 성공")
    void delete_success() {
        // given
        Post post = postRepository.save(Post.builder()
                .title("삭제할 게시글")
                .content("내용")
                .author("테스터")
                .build());

        // when
        postRepository.deleteById(post.getId());

        // then
        Optional<Post> deletedPost = postRepository.findById(post.getId());
        assertThat(deletedPost).isEmpty();
    }
}
```

---

### 2.2 Service 테스트

**PostServiceTest.java:**
```java
package com.simpleblog.service;

import com.simpleblog.dto.PostCreateRequest;
import com.simpleblog.dto.PostListResponse;
import com.simpleblog.dto.PostResponse;
import com.simpleblog.dto.PostUpdateRequest;
import com.simpleblog.entity.Post;
import com.simpleblog.repository.PostRepository;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.List;
import java.util.Optional;

import static org.assertj.core.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.BDDMockito.*;

@ExtendWith(MockitoExtension.class)
class PostServiceTest {

    @Mock
    private PostRepository postRepository;

    @InjectMocks
    private PostService postService;

    @Test
    @DisplayName("게시글 생성 성공")
    void createPost_success() {
        // given
        PostCreateRequest request = new PostCreateRequest();
        // request에 값 설정 (Reflection 또는 생성자 추가 필요)

        Post savedPost = Post.builder()
                .title("테스트 제목")
                .content("테스트 내용")
                .author("테스터")
                .build();

        given(postRepository.save(any(Post.class))).willReturn(savedPost);

        // when
        PostResponse response = postService.createPost(request);

        // then
        assertThat(response.getTitle()).isEqualTo("테스트 제목");
        verify(postRepository, times(1)).save(any(Post.class));
    }

    @Test
    @DisplayName("게시글 조회 성공")
    void getPost_success() {
        // given
        Long postId = 1L;
        Post post = Post.builder()
                .title("테스트 제목")
                .content("테스트 내용")
                .author("테스터")
                .build();

        given(postRepository.findById(postId)).willReturn(Optional.of(post));

        // when
        PostResponse response = postService.getPost(postId);

        // then
        assertThat(response.getTitle()).isEqualTo("테스트 제목");
    }

    @Test
    @DisplayName("존재하지 않는 게시글 조회 시 예외 발생")
    void getPost_notFound_throwException() {
        // given
        Long postId = 999L;
        given(postRepository.findById(postId)).willReturn(Optional.empty());

        // when & then
        assertThatThrownBy(() -> postService.getPost(postId))
                .isInstanceOf(IllegalArgumentException.class)
                .hasMessageContaining("게시글을 찾을 수 없습니다");
    }
}
```

---

## 3. 통합 테스트 (Integration Test)

### 3.1 Controller 테스트 (MockMvc)

**PostControllerTest.java:**
```java
package com.simpleblog.controller;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.simpleblog.dto.PostCreateRequest;
import com.simpleblog.dto.PostUpdateRequest;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.transaction.annotation.Transactional;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@SpringBootTest
@AutoConfigureMockMvc
@Transactional  // 테스트 후 자동 롤백
class PostControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @Test
    @DisplayName("게시글 목록 조회 성공")
    void getAllPosts_success() throws Exception {
        mockMvc.perform(get("/api/posts"))
                .andDo(print())
                .andExpect(status().isOk())
                .andExpect(jsonPath("$").isArray());
    }

    @Test
    @DisplayName("게시글 생성 성공")
    void createPost_success() throws Exception {
        // given
        PostCreateRequest request = new PostCreateRequest();
        // request 설정 필요

        String requestJson = objectMapper.writeValueAsString(request);

        // when & then
        mockMvc.perform(post("/api/posts")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(requestJson))
                .andDo(print())
                .andExpect(status().isCreated())
                .andExpect(jsonPath("$.title").value("테스트 제목"));
    }

    @Test
    @DisplayName("게시글 생성 시 유효성 검증 실패 (제목 없음)")
    void createPost_validation_fail_noTitle() throws Exception {
        // given
        PostCreateRequest request = new PostCreateRequest();
        // title을 설정하지 않음

        String requestJson = objectMapper.writeValueAsString(request);

        // when & then
        mockMvc.perform(post("/api/posts")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(requestJson))
                .andDo(print())
                .andExpect(status().isBadRequest())
                .andExpect(jsonPath("$.error").value("VALIDATION_ERROR"));
    }

    @Test
    @DisplayName("게시글 삭제 성공")
    void deletePost_success() throws Exception {
        // given: 먼저 게시글 생성
        // (실제로는 테스트 데이터 세팅 필요)

        // when & then
        mockMvc.perform(delete("/api/posts/1"))
                .andDo(print())
                .andExpect(status().isNoContent());
    }

    @Test
    @DisplayName("존재하지 않는 게시글 삭제 시 404")
    void deletePost_notFound() throws Exception {
        mockMvc.perform(delete("/api/posts/999"))
                .andDo(print())
                .andExpect(status().isNotFound())
                .andExpect(jsonPath("$.error").value("RESOURCE_NOT_FOUND"));
    }
}
```

---

## 4. 테스트 실행

### 4.1 IDE에서 실행

**IntelliJ IDEA:**
```
1. 테스트 클래스에서 우클릭
2. "Run 'PostServiceTest'" 선택
3. 결과 확인
```

### 4.2 Gradle 명령어로 실행

```bash
# 전체 테스트 실행
./gradlew test

# 특정 테스트만 실행
./gradlew test --tests PostServiceTest

# 테스트 결과 리포트 생성
./gradlew test
# build/reports/tests/test/index.html 열기
```

---

## 5. 테스트 커버리지 측정

### 5.1 JaCoCo 플러그인 추가

**build.gradle:**
```groovy
plugins {
    id 'jacoco'  // 추가
}

jacoco {
    toolVersion = '0.8.11'
}

test {
    finalizedBy jacocoTestReport  // 테스트 후 리포트 자동 생성
}

jacocoTestReport {
    dependsOn test
    reports {
        xml.required = true
        html.required = true
    }
}

jacocoTestCoverageVerification {
    violationRules {
        rule {
            limit {
                minimum = 0.80  // 80% 이상
            }
        }
    }
}
```

### 5.2 커버리지 확인

```bash
# 테스트 + 커버리지 리포트 생성
./gradlew test jacocoTestReport

# 리포트 위치
# build/reports/jacoco/test/html/index.html
```

---

## 6. 테스트 체크리스트

### 개발 완료 후 확인

```
[ ] 전체 테스트 통과 (./gradlew test)
[ ] 테스트 커버리지 80% 이상
[ ] 모든 API 엔드포인트 테스트 작성
[ ] 유효성 검증 실패 케이스 테스트
[ ] 404 에러 케이스 테스트
[ ] 예외 처리 테스트

[ ] Postman Collection 작성 (수동 테스트용)
[ ] README.md에 테스트 실행 방법 추가
[ ] CI/CD 파이프라인에 테스트 통합
```

---

## 7. 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2025-10-17 | 개발팀 | 최초 작성 |

---

**프로젝트 완료!** 🎉

다음 단계: 배포 및 운영 (2차 개발) 🚀
